<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>FitTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #05080f;
  --bg2: #080d18;
  --bg3: #0c1220;
  --bg4: #111a2e;
  --accent: #4d8aff;
  --accent2: #ff6b4d;
  --green: #4dffb4;
  --red: #ff6b4d;
  --yellow: #ffd44d;
  --text: #e8eaf6;
  --text2: #7b8ab8;
  --text3: #3d4d70;
  --border: #1a2440;
  --card: #090e1c;
  --radius: 16px;
  --radius-sm: 10px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; background:var(--bg); color:var(--text); font-family:'DM Sans', sans-serif; overflow:hidden; }

/* APP SHELL */
.app { display:flex; flex-direction:column; height:100vh; max-width:430px; margin:0 auto; position:relative; }

/* HEADER */
.header { padding:16px 20px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); background:var(--bg); position:sticky; top:0; z-index:10; }
.header-title { font-family:'Space Mono', monospace; font-size:18px; font-weight:700; color:var(--accent); letter-spacing:-0.5px; }
.header-date { font-size:12px; color:var(--text2); font-weight:500; }
.header-right { display:flex; align-items:center; gap:8px; }
.day-badge { background:var(--bg3); border:1px solid var(--border); border-radius:20px; padding:4px 12px; font-size:12px; font-weight:600; color:var(--accent); font-family:'Space Mono', monospace; }

/* TABS */
.tabs { display:flex; overflow-x:auto; gap:0; border-bottom:1px solid var(--border); background:var(--bg); scrollbar-width:none; flex-shrink:0; }
.tabs::-webkit-scrollbar { display:none; }
.tab { flex:0 0 auto; padding:10px 16px; font-size:12px; font-weight:600; color:var(--text3); border:none; background:none; cursor:pointer; border-bottom:2px solid transparent; white-space:nowrap; transition:all 0.2s; letter-spacing:0.3px; }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab-icon { display:block; font-size:16px; margin-bottom:2px; }

/* CONTENT */
.content { flex:1; overflow-y:auto; padding:16px; scrollbar-width:none; }
.content::-webkit-scrollbar { display:none; }
.page { display:none; animation:fadeIn 0.2s ease; }
.page.active { display:block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* CARDS */
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:12px; }
.card-title { font-size:11px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.card-title span { font-size:14px; }

/* MACRO RING */
.macro-overview { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:12px; }
.macro-stat { background:var(--bg3); border-radius:var(--radius-sm); padding:12px; text-align:center; border:1px solid var(--border); }
.macro-val { font-family:'Space Mono', monospace; font-size:22px; font-weight:700; line-height:1; }
.macro-label { font-size:10px; color:var(--text2); margin-top:4px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.macro-sub { font-size:10px; color:var(--text3); margin-top:2px; }
.prot-color { color:var(--green); }
.carb-color { color:var(--accent); }
.fat-color { color:var(--yellow); }
.kcal-color { color:var(--red); }

/* PROGRESS BARS */
.prog-row { margin-bottom:10px; }
.prog-header { display:flex; justify-content:space-between; margin-bottom:4px; font-size:12px; }
.prog-label { color:var(--text2); font-weight:500; }
.prog-val { color:var(--text); font-weight:600; font-family:'Space Mono', monospace; font-size:11px; }
.prog-bar { height:6px; background:var(--bg4); border-radius:3px; overflow:hidden; }
.prog-fill { height:100%; border-radius:3px; transition:width 0.4s ease; }
.prog-fill.prot { background:var(--green); }
.prog-fill.carb { background:var(--accent); }
.prog-fill.fat { background:var(--yellow); }
.prog-fill.kcal { background:var(--red); }
.prog-fill.over { background:#e74c3c; }

/* MEAL SECTION */
.meal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.meal-name { font-size:13px; font-weight:700; color:var(--text); }
.meal-kcal { font-size:11px; color:var(--text2); font-family:'Space Mono', monospace; }
.meal-items { display:flex; flex-direction:column; gap:4px; }
.meal-item { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; background:var(--bg3); border-radius:8px; }
.meal-item-name { font-size:12px; color:var(--text); flex:1; }
.meal-item-macros { font-size:10px; color:var(--text2); font-family:'Space Mono', monospace; text-align:right; }
.meal-add-btn { width:100%; padding:8px; border:1px dashed var(--border); border-radius:8px; background:none; color:var(--text3); font-size:12px; cursor:pointer; margin-top:6px; transition:all 0.2s; font-family:'DM Sans', sans-serif; }
.meal-add-btn:hover { border-color:var(--accent); color:var(--accent); }

/* TRAINING */
.exercise-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:8px; overflow:hidden; }
.exercise-header { padding:12px 14px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
.exercise-name { font-size:13px; font-weight:600; color:var(--text); flex:1; }
.exercise-muscle { font-size:10px; color:var(--text2); }
.exercise-chevron { color:var(--text3); font-size:12px; transition:transform 0.2s; }
.exercise-card.open .exercise-chevron { transform:rotate(180deg); }
.sets-container { padding:0 14px 12px; display:none; }
.exercise-card.open .sets-container { display:block; }
.set-row { display:grid; grid-template-columns:30px 1fr 1fr 40px; gap:8px; align-items:center; margin-bottom:6px; }
.set-num { font-size:11px; color:var(--text3); font-family:'Space Mono', monospace; text-align:center; }
.set-input { background:var(--bg4); border:1px solid var(--border); border-radius:6px; padding:6px 8px; color:var(--text); font-size:13px; font-family:'Space Mono', monospace; width:100%; text-align:center; outline:none; }
.set-input:focus { border-color:var(--accent); }
.set-check { width:28px; height:28px; border-radius:6px; border:2px solid var(--border); background:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; transition:all 0.2s; }
.set-check.done { background:var(--green); border-color:var(--green); }
.add-set-btn { font-size:11px; color:var(--accent); background:none; border:none; cursor:pointer; padding:4px 0; font-family:'DM Sans', sans-serif; }

/* SUPPLEMENTS */
.supps-grid { display:flex; flex-direction:column; gap:6px; }
.supp-item { display:flex; align-items:center; gap:12px; padding:10px 14px; background:var(--bg3); border-radius:var(--radius-sm); border:1px solid var(--border); cursor:pointer; transition:all 0.2s; }
.supp-item.taken { background:rgba(46,204,113,0.08); border-color:rgba(46,204,113,0.3); }
.supp-check { width:24px; height:24px; border-radius:50%; border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; transition:all 0.2s; }
.supp-item.taken .supp-check { background:var(--green); border-color:var(--green); }
.supp-info { flex:1; }
.supp-name { font-size:13px; font-weight:500; color:var(--text); }
.supp-dose { font-size:11px; color:var(--text2); margin-top:1px; }
.supp-time { font-size:10px; color:var(--text3); font-family:'Space Mono', monospace; }

/* METRICS */
.metrics-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
.metric-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:14px; text-align:center; }
.metric-val { font-family:'Space Mono', monospace; font-size:26px; font-weight:700; color:var(--accent); }
.metric-unit { font-size:11px; color:var(--text2); }
.metric-label { font-size:11px; color:var(--text2); margin-top:4px; font-weight:600; }
.metric-change { font-size:10px; margin-top:4px; }
.metric-change.up { color:var(--green); }
.metric-change.down { color:var(--red); }
.history-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border); }
.history-date { font-size:12px; color:var(--text2); }
.history-vals { display:flex; gap:16px; }
.history-val { font-size:12px; font-family:'Space Mono', monospace; color:var(--text); }

/* SLEEP */
.sleep-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.sleep-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; }
.sleep-icon { font-size:20px; margin-bottom:6px; }
.sleep-label { font-size:10px; color:var(--text2); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.sleep-val { font-family:'Space Mono', monospace; font-size:20px; font-weight:700; color:var(--text); margin-top:2px; }
.readiness-circle { width:100px; height:100px; margin:0 auto 16px; position:relative; }
.readiness-circle svg { transform:rotate(-90deg); }
.readiness-num { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:'Space Mono', monospace; font-size:28px; font-weight:700; }
.readiness-label { text-align:center; font-size:11px; color:var(--text2); font-weight:700; text-transform:uppercase; letter-spacing:1px; }

/* KCAL OURA */
.kcal-big { text-align:center; padding:20px 0; }
.kcal-num { font-family:'Space Mono', monospace; font-size:52px; font-weight:700; color:var(--accent); line-height:1; }
.kcal-label { font-size:12px; color:var(--text2); margin-top:4px; text-transform:uppercase; letter-spacing:1px; }
.kcal-breakdown { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:16px; }
.kcal-item { background:var(--bg3); border-radius:var(--radius-sm); padding:10px; text-align:center; border:1px solid var(--border); }
.kcal-item-val { font-family:'Space Mono', monospace; font-size:16px; font-weight:700; color:var(--text); }
.kcal-item-label { font-size:9px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; margin-top:3px; }
.balance-bar-wrap { margin-top:16px; }
.balance-label { display:flex; justify-content:space-between; font-size:11px; color:var(--text2); margin-bottom:6px; }
.balance-bar { height:10px; background:var(--bg4); border-radius:5px; overflow:hidden; position:relative; }
.balance-fill-left { position:absolute; right:50%; height:100%; border-radius:5px 0 0 5px; }
.balance-fill-right { position:absolute; left:50%; height:100%; border-radius:0 5px 5px 0; }

/* INPUTS */
.input-group { margin-bottom:10px; }
.input-label { font-size:11px; color:var(--text2); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; display:block; }
.input-row { display:flex; gap:8px; }
.inp { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 12px; color:var(--text); font-size:14px; font-family:'DM Sans', sans-serif; outline:none; width:100%; transition:border 0.2s; }
.inp:focus { border-color:var(--accent); }
.inp::placeholder { color:var(--text3); }
.btn { padding:10px 16px; border-radius:var(--radius-sm); border:none; font-size:13px; font-weight:600; cursor:pointer; font-family:'DM Sans', sans-serif; transition:all 0.2s; }
.btn-primary { background:var(--accent); color:white; }
.btn-primary:hover { background:#3d6ee8; }
.btn-ghost { background:var(--bg3); color:var(--text2); border:1px solid var(--border); }
.btn-sm { padding:6px 12px; font-size:12px; }

/* MODALS */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:100; display:flex; align-items:flex-end; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal { background:var(--bg2); border-radius:24px 24px 0 0; padding:20px; width:100%; max-width:430px; transform:translateY(100%); transition:transform 0.3s ease; max-height:80vh; overflow-y:auto; }
.modal-overlay.open .modal { transform:translateY(0); }
.modal-title { font-size:16px; font-weight:700; margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; }
.modal-close { background:var(--bg3); border:none; color:var(--text2); width:28px; height:28px; border-radius:50%; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; }

/* TAGS */
.tag { display:inline-block; padding:3px 8px; border-radius:20px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
.tag-green { background:rgba(46,204,113,0.15); color:var(--green); }
.tag-red { background:rgba(231,76,60,0.15); color:var(--red); }
.tag-blue { background:rgba(79,126,255,0.15); color:var(--accent); }
.tag-yellow { background:rgba(243,156,18,0.15); color:var(--yellow); }

/* SECTION DIVIDER */
.section-div { font-size:11px; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:1px; margin:16px 0 8px; }

/* EMPTY STATE */
.empty { text-align:center; padding:40px 20px; color:var(--text3); font-size:13px; }
.empty-icon { font-size:36px; margin-bottom:8px; }

/* TOAST */
.toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--bg3); border:1px solid var(--border); border-radius:20px; padding:8px 16px; font-size:13px; font-weight:500; opacity:0; transition:all 0.3s; z-index:200; white-space:nowrap; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* BOTTOM NAV (alternative to tabs for mobile) */
.nav-hint { text-align:center; padding:6px; font-size:10px; color:var(--text3); border-top:1px solid var(--border); flex-shrink:0; }

/* CHARTS & PROGRESS */
.chart-wrap { width:100%; height:160px; margin-top:8px; }
.chart-svg { width:100%; height:100%; overflow:visible; }
.chart-line { fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; }
.chart-area { opacity:0.12; }
.chart-label-x { font-size:9px; fill:var(--text3); text-anchor:middle; font-family:'Space Mono',monospace; }
.chart-label-y { font-size:9px; fill:var(--text3); text-anchor:end; font-family:'Space Mono',monospace; }
.chart-grid { stroke:var(--border); stroke-width:1; }
.prog-selector { display:flex; gap:6px; overflow-x:auto; margin-bottom:10px; scrollbar-width:none; }
.prog-selector::-webkit-scrollbar { display:none; }
.prog-sel-btn { flex-shrink:0; padding:5px 12px; background:var(--bg3); border:1px solid var(--border); border-radius:20px; font-size:11px; color:var(--text2); cursor:pointer; font-family:'DM Sans',sans-serif; white-space:nowrap; transition:all 0.2s; }
.prog-sel-btn.active { background:var(--accent); color:white; border-color:var(--accent); }
.stat-trio { display:flex; gap:8px; margin-top:10px; }
.stat-pill { flex:1; text-align:center; background:var(--bg3); border-radius:8px; padding:8px 4px; border:1px solid var(--border); }
.stat-pill-val { font-family:'Space Mono',monospace; font-size:15px; font-weight:700; }
.stat-pill-lbl { font-size:10px; color:var(--text2); margin-top:2px; }
.suggestion-card { border-radius:var(--radius-sm); padding:12px 14px; margin-bottom:8px; display:flex; align-items:flex-start; gap:10px; }
.suggestion-card.warn { background:rgba(243,156,18,0.08); border:1px solid rgba(243,156,18,0.3); }
.suggestion-card.success { background:rgba(46,204,113,0.08); border:1px solid rgba(46,204,113,0.3); }
.suggestion-card.info { background:rgba(79,126,255,0.08); border:1px solid rgba(79,126,255,0.3); }
.suggestion-icon { font-size:18px; flex-shrink:0; }
.suggestion-title { font-size:12px; font-weight:700; color:var(--text); }
.suggestion-sub { font-size:11px; color:var(--text2); margin-top:2px; line-height:1.4; }
.ex-history-item { padding:8px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.ex-history-date { font-size:11px; color:var(--text2); }
.ex-history-val { font-size:12px; font-family:'Space Mono',monospace; color:var(--text); }
.ex-history-pr { font-size:10px; color:var(--yellow); font-weight:700; margin-left:6px; }
.ex-select { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:8px 12px; color:var(--text); font-size:12px; font-family:'DM Sans',sans-serif; outline:none; width:100%; margin-bottom:12px; }
/* AI CHAT MODAL */
.ai-modal { background:var(--bg2); border-radius:24px 24px 0 0; width:100%; max-width:430px; transform:translateY(100%); transition:transform 0.3s ease; height:85vh; display:flex; flex-direction:column; overflow:hidden; }
.modal-overlay.open .ai-modal { transform:translateY(0); }
.ai-modal-header { padding:16px 20px 12px; border-bottom:1px solid var(--border); flex-shrink:0; }
.ai-modal-title { font-size:16px; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
.ai-modal-subtitle { font-size:11px; color:var(--text2); margin-top:3px; }
.ai-chat-area { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; scrollbar-width:none; }
.ai-chat-area::-webkit-scrollbar { display:none; }
.ai-bubble { max-width:85%; padding:10px 14px; border-radius:16px; font-size:13px; line-height:1.5; }
.ai-bubble.user { align-self:flex-end; background:var(--accent); color:white; border-bottom-right-radius:4px; }
.ai-bubble.bot { align-self:flex-start; background:var(--bg3); color:var(--text); border-bottom-left-radius:4px; border:1px solid var(--border); }
.ai-bubble.bot.loading { color:var(--text2); font-style:italic; }
.ai-result-card { background:var(--bg4); border-radius:12px; padding:12px; margin-top:8px; border:1px solid var(--border); }
.ai-result-macros { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:6px; margin-bottom:8px; }
.ai-macro-pill { background:var(--bg3); border-radius:8px; padding:6px 4px; text-align:center; }
.ai-macro-pill .val { font-family:'Space Mono',monospace; font-size:14px; font-weight:700; }
.ai-macro-pill .lbl { font-size:9px; color:var(--text2); text-transform:uppercase; margin-top:2px; }
.ai-items-list { font-size:11px; color:var(--text2); margin-bottom:8px; line-height:1.8; }
.ai-notes { font-size:11px; color:var(--accent); font-style:italic; margin-bottom:10px; }
.ai-add-btns { display:flex; gap:6px; flex-wrap:wrap; }
.ai-meal-btn { flex:1; min-width:80px; padding:7px 8px; background:var(--bg3); border:1px solid var(--border); border-radius:8px; color:var(--text2); font-size:11px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.2s; text-align:center; }
.ai-meal-btn:hover,.ai-meal-btn.primary { background:var(--accent); color:white; border-color:var(--accent); }
.ai-input-area { padding:12px 16px; border-top:1px solid var(--border); flex-shrink:0; background:var(--bg2); }
.ai-quick-chips { display:flex; gap:6px; overflow-x:auto; margin-bottom:10px; scrollbar-width:none; }
.ai-quick-chips::-webkit-scrollbar { display:none; }
.ai-chip { flex-shrink:0; padding:5px 10px; background:var(--bg3); border:1px solid var(--border); border-radius:20px; font-size:11px; color:var(--text2); cursor:pointer; white-space:nowrap; transition:all 0.2s; }
.ai-chip:hover { border-color:var(--accent); color:var(--accent); }
.ai-input-row { display:flex; gap:8px; align-items:center; }
.ai-inp { flex:1; background:var(--bg3); border:1px solid var(--border); border-radius:24px; padding:10px 16px; color:var(--text); font-size:13px; font-family:'DM Sans',sans-serif; outline:none; }
.ai-inp:focus { border-color:var(--accent); }
.ai-inp::placeholder { color:var(--text3); }
.ai-send-btn { width:40px; height:40px; border-radius:50%; background:var(--accent); border:none; color:white; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.ai-send-btn:disabled { background:var(--bg4); cursor:not-allowed; }
/* HOME DASHBOARD */
.home-greeting { font-size:22px; font-weight:700; color:var(--text); margin-bottom:2px; }
.home-sub { font-size:12px; color:var(--text2); margin-bottom:16px; }
.home-balance { background:linear-gradient(135deg,#1a1a2e,#16213e); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:12px; text-align:center; position:relative; overflow:hidden; }
.home-balance::before { content:''; position:absolute; top:-40px; right:-40px; width:120px; height:120px; border-radius:50%; background:var(--accent); opacity:0.06; }
.home-balance-num { font-family:'Space Mono',monospace; font-size:48px; font-weight:700; line-height:1; }
.home-balance-lbl { font-size:11px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-top:4px; }
.home-balance-row { display:flex; justify-content:center; gap:20px; margin-top:14px; }
.home-bal-item { text-align:center; }
.home-bal-val { font-family:'Space Mono',monospace; font-size:14px; font-weight:700; color:var(--text); }
.home-bal-lbl { font-size:10px; color:var(--text2); margin-top:2px; }
.home-macros { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:12px; }
.home-macro { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-sm); padding:14px 10px; text-align:center; }
.home-macro-ring { width:56px; height:56px; margin:0 auto 8px; position:relative; }
.home-macro-ring svg { transform:rotate(-90deg); }
.home-macro-ring-val { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:'Space Mono',monospace; font-size:12px; font-weight:700; }
.home-macro-name { font-size:10px; color:var(--text2); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.home-macro-grams { font-size:11px; color:var(--text3); margin-top:2px; font-family:'Space Mono',monospace; }
.home-quick { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px; }
.home-quick-btn { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-sm); padding:14px; display:flex; align-items:center; gap:10px; cursor:pointer; transition:all 0.2s; }
.home-quick-btn:active { border-color:var(--accent); background:var(--bg3); }
.home-quick-icon { font-size:22px; }
.home-quick-label { font-size:12px; font-weight:600; color:var(--text); }
.home-quick-sub { font-size:10px; color:var(--text2); margin-top:1px; }
.home-oura { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-sm); padding:14px; display:flex; align-items:center; gap:12px; margin-bottom:12px; }
.home-oura-score { width:48px; height:48px; border-radius:50%; border:3px solid var(--accent); display:flex; align-items:center; justify-content:center; font-family:'Space Mono',monospace; font-size:16px; font-weight:700; color:var(--accent); flex-shrink:0; }
.home-oura-info { flex:1; }
.home-oura-title { font-size:13px; font-weight:700; color:var(--text); }
.home-oura-sub { font-size:11px; color:var(--text2); margin-top:2px; }

/* HOME DASHBOARD */
.day-score-circle { width:180px; height:180px; margin:20px auto; position:relative; }
.day-score-circle svg { transform:rotate(-90deg); }
.day-score-num { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:'Space Mono', monospace; font-size:52px; font-weight:700; color:var(--accent); flex-direction:column; }
.day-score-unit { font-size:14px; color:var(--text2); margin-top:-4px; }
.day-score-label { text-align:center; font-size:12px; color:var(--text2); margin-top:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
.day-score-msg { text-align:center; font-size:13px; color:var(--text); margin-top:6px; font-weight:500; max-width:280px; margin-left:auto; margin-right:auto; }
.day-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:20px; }
.day-metric-item { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; text-align:center; }
.day-metric-icon { font-size:18px; margin-bottom:4px; }
.day-metric-val { font-family:'Space Mono', monospace; font-size:16px; font-weight:700; color:var(--text); }
.day-metric-lbl { font-size:10px; color:var(--text2); margin-top:3px; text-transform:uppercase; letter-spacing:0.5px; }
.day-metric-status { font-size:9px; color:var(--text3); margin-top:2px; }
.day-tips { margin-top:20px; }
.day-tip-item { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:12px; margin-bottom:8px; display:flex; gap:10px; }
.day-tip-icon { font-size:18px; flex-shrink:0; }
.day-tip-content { flex:1; }
.day-tip-title { font-size:12px; font-weight:700; color:var(--text); }
.day-tip-sub { font-size:11px; color:var(--text2); margin-top:2px; line-height:1.4; }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="header-title">FitTrack</div>
      <div class="header-date" id="headerDate"></div>
    </div>
    <div class="header-right">
      <div class="day-badge" id="dayBadge">DIA 1</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="showPage('home')"><span class="tab-icon">üìä</span>Resumen</button>
    <button class="tab" onclick="showPage('macros')"><span class="tab-icon">üçΩ</span>Macros</button>
    <button class="tab" onclick="showPage('training')"><span class="tab-icon">üí™</span>Entreno</button>
    <button class="tab" onclick="showPage('supps')"><span class="tab-icon">üíä</span>Supls</button>
    <button class="tab" onclick="showPage('metrics')"><span class="tab-icon">üìä</span>Metricas</button>
    <button class="tab" onclick="showPage('sleep')"><span class="tab-icon">üåô</span>Sueno</button>
    <button class="tab" onclick="showPage('kcal')"><span class="tab-icon">üî•</span>Kcal</button>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- ‚ïê‚ïê‚ïê HOME PAGE ‚ïê‚ïê‚ïê -->
    <div class="page active" id="page-home">
      <div style="padding-top:20px">
        <div style="text-align:center;margin-bottom:8px">
          <div style="font-size:28px;font-weight:700;color:var(--accent);letter-spacing:-0.5px">üìä RESUMEN DEL D√çA</div>
          <div style="font-size:12px;color:var(--text2);margin-top:2px" id="homeDate"></div>
        </div>
        
        <div class="card">
          <div class="day-score-circle">
            <svg width="180" height="180" viewBox="0 0 180 180">
              <circle cx="90" cy="90" r="75" fill="none" stroke="var(--bg4)" stroke-width="10"/>
              <circle cx="90" cy="90" r="75" fill="none" stroke="var(--accent)" stroke-width="10"
                stroke-dasharray="471" id="dayScoreDash" stroke-dashoffset="471" stroke-linecap="round"/>
            </svg>
            <div class="day-score-num">
              <span id="dayScore">‚Äî</span>
              <span class="day-score-unit">/100</span>
            </div>
          </div>
          <div class="day-score-label" id="dayScoreLabel">Cargando...</div>
          <div class="day-score-msg" id="dayScoreMsg"></div>
        </div>

        <div class="day-metrics">
          <div class="day-metric-item">
            <div class="day-metric-icon">üçΩ</div>
            <div class="day-metric-val" id="dayMacroScore">‚Äî</div>
            <div class="day-metric-lbl">Macros</div>
            <div class="day-metric-status" id="dayMacroStatus"></div>
          </div>
          <div class="day-metric-item">
            <div class="day-metric-icon">üí™</div>
            <div class="day-metric-val" id="dayTrainScore">‚Äî</div>
            <div class="day-metric-lbl">Entreno</div>
            <div class="day-metric-status" id="dayTrainStatus"></div>
          </div>
          <div class="day-metric-item">
            <div class="day-metric-icon">üåô</div>
            <div class="day-metric-val" id="daySleepScore">‚Äî</div>
            <div class="day-metric-lbl">Sue√±o</div>
            <div class="day-metric-status" id="daySleepStatus"></div>
          </div>
          <div class="day-metric-item">
            <div class="day-metric-icon">üíä</div>
            <div class="day-metric-val" id="daySuppScore">‚Äî</div>
            <div class="day-metric-lbl">Suplementos</div>
            <div class="day-metric-status" id="daySuppStatus"></div>
          </div>
          <div class="day-metric-item">
            <div class="day-metric-icon">üî•</div>
            <div class="day-metric-val" id="dayKcalScore">‚Äî</div>
            <div class="day-metric-lbl">Balance Kcal</div>
            <div class="day-metric-status" id="dayKcalStatus"></div>
          </div>
          <div class="day-metric-item">
            <div class="day-metric-icon">‚è∞</div>
            <div class="day-metric-val" id="dayStepsScore">‚Äî</div>
            <div class="day-metric-lbl">Pasos</div>
            <div class="day-metric-status" id="dayStepsStatus"></div>
          </div>
        </div>

        <div class="day-tips">
          <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üí° Sugerencias</div>
          <div id="homeTipsContainer"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MACROS PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-macros">
      <div class="card">
        <div class="card-title"><span>üìà</span> Resumen del dia</div>
        <div class="macro-overview">
          <div class="macro-stat">
            <div class="macro-val prot-color" id="totalProt">0</div>
            <div class="macro-label">Proteina</div>
            <div class="macro-sub">/ 190g</div>
          </div>
          <div class="macro-stat">
            <div class="macro-val carb-color" id="totalCarb">0</div>
            <div class="macro-label">Carbos</div>
            <div class="macro-sub">/ 240g</div>
          </div>
          <div class="macro-stat">
            <div class="macro-val fat-color" id="totalFat">0</div>
            <div class="macro-label">Grasas</div>
            <div class="macro-sub">/ 70g</div>
          </div>
        </div>
        <div class="prog-row">
          <div class="prog-header"><span class="prog-label">Proteina</span><span class="prog-val" id="protPct">0%</span></div>
          <div class="prog-bar"><div class="prog-fill prot" id="protBar" style="width:0%"></div></div>
        </div>
        <div class="prog-row">
          <div class="prog-header"><span class="prog-label">Carbos</span><span class="prog-val" id="carbPct">0%</span></div>
          <div class="prog-bar"><div class="prog-fill carb" id="carbBar" style="width:0%"></div></div>
        </div>
        <div class="prog-row">
          <div class="prog-header"><span class="prog-label">Grasas</span><span class="prog-val" id="fatPct">0%</span></div>
          <div class="prog-bar"><div class="prog-fill fat" id="fatBar" style="width:0%"></div></div>
        </div>
        <div class="prog-row">
          <div class="prog-header"><span class="prog-label">Calorias</span><span class="prog-val" id="kcalPct">0 / 2400</span></div>
          <div class="prog-bar"><div class="prog-fill kcal" id="kcalBar" style="width:0%"></div></div>
        </div>
      </div>

      <!-- MEALS -->
      <div id="mealsContainer"></div>

      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-primary" style="flex:1" onclick="openAddFood()">+ Agregar</button>
        <button class="btn btn-ghost" style="flex:1;border-color:var(--accent2);color:var(--accent2)" onclick="openAIChat()">‚ú® IA Macros</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê TRAINING PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-training">
      <div class="card" style="margin-bottom:12px">
        <div class="card-title"><span>üìÖ</span> Dia de hoy</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap" id="daySelector">
          <button class="btn btn-sm" onclick="setTrainDay(1)" id="tbtn1">DIA 1 ‚Äî Push</button>
          <button class="btn btn-sm" onclick="setTrainDay(2)" id="tbtn2">DIA 2 ‚Äî Pull</button>
          <button class="btn btn-sm" onclick="setTrainDay(3)" id="tbtn3">DIA 3 ‚Äî Hombros</button>
          <button class="btn btn-sm" onclick="setTrainDay(4)" id="tbtn4">DIA 4 ‚Äî Push H</button>
          <button class="btn btn-sm" onclick="setTrainDay(5)" id="tbtn5">DIA 5 ‚Äî Pull H</button>
          <button class="btn btn-sm btn-ghost" onclick="setTrainDay(0)" id="tbtn0">Descanso</button>
        </div>
      </div>
      <div id="exerciseList"></div>

      <!-- SUGERENCIAS -->
      <div class="section-div" style="margin-top:4px">üí° Sugerencias</div>
      <div id="trainSuggestions"></div>

      <!-- FUERZA POR EJERCICIO -->
      <div class="section-div">üìà Progreso por ejercicio</div>
      <div class="card">
        <select class="ex-select" id="exSelect" onchange="renderStrengthChart()">
          <option value="">‚Äî Seleccionar ejercicio ‚Äî</option>
        </select>
        <div id="strengthChartWrap" style="display:none">
          <div class="chart-wrap">
            <svg class="chart-svg" id="strengthChartSvg" viewBox="0 0 360 160" preserveAspectRatio="none"></svg>
          </div>
        </div>
        <div id="strengthChartStats"></div>
        <div id="exHistoryList"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SUPPLEMENTS PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-supps">
      <div class="card">
        <div class="card-title"><span>üíä</span> Estado de hoy</div>
        <div style="display:flex;gap:8px;margin-bottom:4px">
          <span id="suppDoneCount" class="macro-val prot-color" style="font-size:28px">0</span>
          <div style="align-self:flex-end;margin-bottom:4px">
            <div style="font-size:12px;color:var(--text2)">de <strong id="suppTotal">8</strong> tomados</div>
          </div>
        </div>
        <div class="prog-bar" style="height:8px">
          <div class="prog-fill prot" id="suppBar" style="width:0%"></div>
        </div>
      </div>

      <div class="section-div">Manana ‚Äî con el desayuno</div>
      <div class="supps-grid" id="suppsMorning"></div>
      <div class="section-div">Mediodia ‚Äî con el almuerzo</div>
      <div class="supps-grid" id="suppsNoon"></div>
      <div class="section-div">Noche ‚Äî antes de dormir</div>
      <div class="supps-grid" id="suppsNight"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê METRICS PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-metrics">
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-val" id="metricWeight">‚Äî</div>
          <div class="metric-unit">kg</div>
          <div class="metric-label">Peso</div>
          <div class="metric-change" id="weightChange"></div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="metricBF" style="color:var(--yellow)">‚Äî</div>
          <div class="metric-unit">%</div>
          <div class="metric-label">% Grasa</div>
          <div class="metric-change" id="bfChange"></div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="metricMuscle" style="color:var(--green)">‚Äî</div>
          <div class="metric-unit">%</div>
          <div class="metric-label">% Muscular</div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="metricWaist" style="color:var(--accent2)">‚Äî</div>
          <div class="metric-unit">cm</div>
          <div class="metric-label">Cintura</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span>‚ûï</span> Registrar medicion</div>
        <div class="input-group">
          <label class="input-label">Peso (kg)</label>
          <input class="inp" id="inpWeight" type="number" step="0.1" placeholder="77.0">
        </div>
        <div class="input-row" style="margin-bottom:10px">
          <div style="flex:1">
            <label class="input-label">% Grasa</label>
            <input class="inp" id="inpBF" type="number" step="0.1" placeholder="17.6">
          </div>
          <div style="flex:1">
            <label class="input-label">% Muscular</label>
            <input class="inp" id="inpMuscle" type="number" step="0.1" placeholder="78.0">
          </div>
        </div>
        <div class="input-group">
          <label class="input-label">Cintura (cm)</label>
          <input class="inp" id="inpWaist" type="number" step="0.5" placeholder="82">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="saveMetrics()">Guardar medicion</button>
      </div>

      <!-- GRAFICOS EVOLUCION -->
      <div class="section-div">üìà Evolucion</div>
      <div class="card">
        <div class="prog-selector" id="bodyChartSelector">
          <button class="prog-sel-btn active" onclick="selectBodyChart('weight',this)">‚öñÔ∏è Peso</button>
          <button class="prog-sel-btn" onclick="selectBodyChart('bf',this)">üü° % Grasa</button>
          <button class="prog-sel-btn" onclick="selectBodyChart('muscle',this)">üü¢ % Muscular</button>
          <button class="prog-sel-btn" onclick="selectBodyChart('waist',this)">üìè Cintura</button>
        </div>
        <div class="chart-wrap">
          <svg class="chart-svg" id="bodyChartSvg" viewBox="0 0 360 160" preserveAspectRatio="none"></svg>
        </div>
        <div class="stat-trio" id="bodyChartStats"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SLEEP PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-sleep">
      <div class="card" style="text-align:center;padding:20px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div class="card-title" style="margin-bottom:0"><span>üåô</span> Disposicion Oura hoy</div>
          <button id="syncBtn" onclick="syncOura()" class="btn btn-sm" style="background:var(--bg3);border:1px solid var(--border);color:var(--accent);font-size:11px">‚Üª Sync Oura</button>
        </div>
        <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px">
          <span id="syncStatus" style="font-size:11px;color:var(--text3)">‚óè Sin sincronizar</span>
          <span id="lastSync" style="font-size:10px;color:var(--text3)"></span>
        </div>
        <div class="readiness-circle">
          <svg width="100" height="100" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg4)" stroke-width="8"/>
            <circle cx="50" cy="50" r="40" fill="none" stroke="var(--accent)" stroke-width="8"
              stroke-dasharray="251.2" id="readinessDash" stroke-dashoffset="251.2" stroke-linecap="round"/>
          </svg>
          <div class="readiness-num" id="readinessNum">‚Äî</div>
        </div>
        <div class="readiness-label" id="readinessLabel">Sin datos</div>
      </div>

      <div class="sleep-grid">
        <div class="sleep-card">
          <div class="sleep-icon">üò¥</div>
          <div class="sleep-label">Horas de sueno</div>
          <div class="sleep-val" id="sleepHours">‚Äî</div>
        </div>
        <div class="sleep-card">
          <div class="sleep-icon">üìä</div>
          <div class="sleep-label">Eficiencia</div>
          <div class="sleep-val" id="sleepEff">‚Äî</div>
        </div>
        <div class="sleep-card">
          <div class="sleep-icon">üåä</div>
          <div class="sleep-label">Sueno profundo</div>
          <div class="sleep-val" id="sleepDeep">‚Äî</div>
        </div>
        <div class="sleep-card">
          <div class="sleep-icon">üíì</div>
          <div class="sleep-label">HRV (ms)</div>
          <div class="sleep-val" id="sleepHRV">‚Äî</div>
        </div>
      </div>

      <div class="section-div">Semana ‚Äî HRV</div>
      <div class="card">
        <div id="hrvChart" style="display:flex;align-items:flex-end;gap:6px;height:60px;padding-top:8px"></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px" id="hrvLabels"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê KCAL OURA PAGE ‚ïê‚ïê‚ïê -->
    <div class="page" id="page-kcal">
      <div class="card">
        <div class="card-title"><span>üî•</span> Balance calorico hoy</div>
        <div class="kcal-big">
          <div class="kcal-num" id="kcalBalance">0</div>
          <div class="kcal-label">Balance neto</div>
        </div>
        <div class="kcal-breakdown">
          <div class="kcal-item">
            <div class="kcal-item-val" id="kcalConsumed">0</div>
            <div class="kcal-item-label">Consumidas</div>
          </div>
          <div class="kcal-item">
            <div class="kcal-item-val" id="kcalBurned">0</div>
            <div class="kcal-item-label">Quemadas</div>
          </div>
          <div class="kcal-item">
            <div class="kcal-item-val" id="kcalTarget">-300</div>
            <div class="kcal-item-label">Objetivo</div>
          </div>
        </div>
        <div class="balance-bar-wrap">
          <div class="balance-label"><span>Deficit</span><span>Superavit</span></div>
          <div class="balance-bar">
            <div class="balance-fill-left" id="deficitBar" style="width:0%;background:var(--green)"></div>
            <div class="balance-fill-right" id="surplusBar" style="width:0%;background:var(--red)"></div>
          </div>
        </div>
      </div>

      <div class="section-div">Historial semanal</div>
      <div id="kcalHistory"></div>
    </div>

  </div><!-- /content -->
  <div class="nav-hint">Desliza las pestanas para ver todas las secciones</div>
</div><!-- /app -->

<!-- MODALS -->
<div class="modal-overlay" id="addFoodModal" onclick="closeModal('addFoodModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title">
      Agregar alimento
      <button class="modal-close" onclick="closeModal('addFoodModal')">‚úï</button>
    </div>
    <div class="input-group">
      <label class="input-label">‚ö° Predeterminados</label>
      <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:4px">
        <button class="btn btn-ghost" style="text-align:left;font-size:12px;padding:8px 12px" onclick="fillPreset('Leche Proteica Lacte√° (200ml)', 9.2, 9.2, 0)">
          ü•õ Leche Proteica Lacte√° (200ml) ‚Äî 9.2p ¬∑ 9.2c ¬∑ 0g
        </button>
        <button class="btn btn-ghost" style="text-align:left;font-size:12px;padding:8px 12px" onclick="fillPreset('Yogur SER Proteico (175g)', 15, 14, 1.9)">
          ü´ô Yogur SER Proteico (175g) ‚Äî 15p ¬∑ 14c ¬∑ 1.9g
        </button>
      </div>
      <div style="font-size:10px;color:var(--text3);margin-bottom:10px;text-align:center">‚Äî o ingres√° manualmente ‚Äî</div>
    </div>
    <div class="input-group">
      <label class="input-label">Nombre</label>
      <input class="inp" id="foodName" placeholder="Pechuga de pollo">
    </div>
    <div class="input-row">
      <div style="flex:1"><label class="input-label">Proteina (g)</label><input class="inp" id="foodProt" type="number" placeholder="0"></div>
      <div style="flex:1"><label class="input-label">Carbos (g)</label><input class="inp" id="foodCarb" type="number" placeholder="0"></div>
      <div style="flex:1"><label class="input-label">Grasas (g)</label><input class="inp" id="foodFat" type="number" placeholder="0"></div>
    </div>
    <div class="input-group" style="margin-top:10px">
      <label class="input-label">Comida</label>
      <select class="inp" id="foodMeal">
        <option value="Desayuno">Desayuno</option>
        <option value="Almuerzo">Almuerzo</option>
        <option value="Merienda">Merienda</option>
        <option value="Cena">Cena</option>
        <option value="Extra">Extra / Snack</option>
      </select>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="addFood()">Agregar</button>
  </div>
</div>


<!-- AI CHAT MODAL -->
<div class="modal-overlay" id="aiChatModal" onclick="if(event.target===this)closeAIChat()">
  <div class="ai-modal">
    <div class="ai-modal-header">
      <div class="ai-modal-title">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:20px">‚ú®</span>
          <div>
            <div>IA Nutricional</div>
            <div class="ai-modal-subtitle">Gemini ¬∑ Calcul√° macros en segundos</div>
          </div>
        </div>
        <button class="modal-close" onclick="closeAIChat()">‚úï</button>
      </div>
    </div>
    <div class="ai-chat-area" id="aiChatArea">
      <div class="ai-bubble bot">
        üëã Decime qu√© comiste y calculo los macros.<br><br>
        <strong>Ejemplos:</strong><br>
        ‚Ä¢ 200g carne vacuna y 300g papa<br>
        ‚Ä¢ bowl de avena con banana y miel<br>
        ‚Ä¢ 2 huevos revueltos con tostadas
      </div>
    </div>
    <div class="ai-input-area">
      <div class="ai-quick-chips">
        <div class="ai-chip" onclick="sendAIChip(this)">200g pechuga pollo</div>
        <div class="ai-chip" onclick="sendAIChip(this)">150g arroz cocido</div>
        <div class="ai-chip" onclick="sendAIChip(this)">2 huevos revueltos</div>
        <div class="ai-chip" onclick="sendAIChip(this)">100g at√∫n en lata</div>
        <div class="ai-chip" onclick="sendAIChip(this)">1 banana mediana</div>
      </div>
      <div class="ai-input-row">
        <input class="ai-inp" id="aiInput" placeholder="Ej: 200g carne y 300g papa..." onkeydown="if(event.key==='Enter')sendAIMessage()">
        <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">‚Üë</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TODAY = new Date().toISOString().split('T')[0];

function loadState() {
  try { return JSON.parse(localStorage.getItem('fittrack') || '{}'); } catch(e) { return {}; }
}
function saveState(s) {
  localStorage.setItem('fittrack', JSON.stringify(s));
}

let state = loadState();

// Limpiar d√≠as viejos (guardar solo √∫ltimos 30 d√≠as)
const allKeys = Object.keys(state).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/));
allKeys.sort();
if (allKeys.length > 30) {
  allKeys.slice(0, allKeys.length - 30).forEach(k => delete state[k]);
  saveState(state);
}

if (!state[TODAY]) state[TODAY] = { foods:[], supps:{}, sleep:{}, metrics:null, kcal:{burned:0,active:0}, trainDay: state.lastTrainDay || 1 };
if (!state.metricsHistory) state.metricsHistory = [];
if (!state.kcalHistory) state.kcalHistory = [];
if (!state.exerciseHistory) state.exerciseHistory = {};

// ‚îÄ‚îÄ‚îÄ TRAINING DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TRAINING = {
  1: { name:"DIA 1 ‚Äî Push Pesado + Core", exercises:[
    { name:"Press banca plano (barra)", muscle:"Pecho, Triceps", sets:4, reps:"5-6" },
    { name:"Press inclinado (mancuernas)", muscle:"Pecho superior", sets:3, reps:"8-10" },
    { name:"Fondos lastrados", muscle:"Pecho, Triceps", sets:3, reps:"6-8" },
    { name:"Extension triceps (barra W)", muscle:"Triceps", sets:3, reps:"10-12" },
    { name:"Ab wheel", muscle:"Core", sets:4, reps:"6-10" },
    { name:"Dead hang", muscle:"Agarre", sets:3, reps:"max" },
  ]},
  2: { name:"DIA 2 ‚Äî Pull Pesado + Agarre", exercises:[
    { name:"Dominadas lastradas", muscle:"Dorsal, Biceps", sets:4, reps:"5-6" },
    { name:"Remo con barra", muscle:"Dorsal, Trapecio", sets:4, reps:"6-8" },
    { name:"Remo unilateral mancuerna", muscle:"Dorsal, Biceps", sets:3, reps:"8-10" },
    { name:"Vuelo posterior", muscle:"Hombro posterior", sets:2, reps:"15-20" },
    { name:"Curl biceps barra W", muscle:"Biceps", sets:3, reps:"8-10" },
    { name:"Curl martillo", muscle:"Braquial", sets:2, reps:"10-12" },
    { name:"Farmer's carry", muscle:"Agarre, Trapecio", sets:3, reps:"30-40m" },
  ]},
  3: { name:"DIA 3 ‚Äî Hombros + Antebrazo", exercises:[
    { name:"Press militar (barra)", muscle:"Hombros, Triceps", sets:4, reps:"6-8" },
    { name:"Elevaciones laterales", muscle:"Hombro lateral", sets:5, reps:"15-20" },
    { name:"Vuelo posterior", muscle:"Hombro posterior", sets:4, reps:"15-20" },
    { name:"Curl de muneca normal", muscle:"Flexores antebrazo", sets:4, reps:"12-20" },
    { name:"Curl invertido (barra)", muscle:"Extensores antebrazo", sets:3, reps:"10-15" },
    { name:"Curl muneca invertido", muscle:"Dorso antebrazo", sets:3, reps:"12-15" },
    { name:"Ab wheel", muscle:"Core", sets:2, reps:"8-12" },
    { name:"Dead hang", muscle:"Agarre", sets:3, reps:"max" },
  ]},
  4: { name:"DIA 4 ‚Äî Push Hipertrofia + Core", exercises:[
    { name:"Press inclinado", muscle:"Pecho superior", sets:4, reps:"8-10" },
    { name:"Press hombros mancuernas", muscle:"Hombros, Triceps", sets:3, reps:"10-12" },
    { name:"Fondos normales", muscle:"Pecho, Triceps", sets:3, reps:"8-12" },
    { name:"Extension triceps overhead", muscle:"Triceps", sets:3, reps:"10-12" },
    { name:"Vuelo pecho plano", muscle:"Pecho medio", sets:3, reps:"12-15" },
    { name:"Ab wheel", muscle:"Core", sets:3, reps:"8-12" },
    { name:"Isometrico de agarre", muscle:"Agarre", sets:3, reps:"35-45s" },
  ]},
  5: { name:"DIA 5 ‚Äî Pull Hipertrofia + Agarre", exercises:[
    { name:"Dominadas agarre neutro", muscle:"Dorsal, Biceps", sets:3, reps:"8-12" },
    { name:"Remo inclinado bilateral", muscle:"Dorsal, Trapecio", sets:3, reps:"8-12" },
    { name:"Curl inclinado mancuernas", muscle:"Biceps", sets:3, reps:"10-12" },
    { name:"Curl martillo", muscle:"Braquial", sets:2, reps:"10-12" },
    { name:"Elevaciones laterales", muscle:"Hombro lateral", sets:3, reps:"15-20" },
    { name:"Dead hang", muscle:"Agarre", sets:4, reps:"max" },
    { name:"Pinch grip (discos)", muscle:"Dedos, Agarre", sets:3, reps:"30-40s" },
    { name:"Curl de cuerda", muscle:"Antebrazo completo", sets:3, reps:"hasta agotar" },
  ]},
};

const SUPPS = [
  { id:"creatina",  name:"Creatina",       dose:"5g (4 caps)",        time:"Manana", group:"morning" },
  { id:"d3k2",      name:"D3 + K2",        dose:"1 softgel",          time:"Manana", group:"morning" },
  { id:"vitc",      name:"Vitamina C",     dose:"1 capsula",          time:"Manana", group:"morning" },
  { id:"omega3",    name:"Omega 3",        dose:"2 softgels",         time:"Mediodia", group:"noon" },
  { id:"astax",     name:"Astaxanthin",    dose:"1 softgel",          time:"Mediodia", group:"noon" },
  { id:"magglicin", name:"Mag. Glicinato", dose:"2 softgels",         time:"Noche", group:"night" },
  { id:"magthreon", name:"Mag. L-Treonato","dose":"3 capsulas",       time:"Noche", group:"night" },
];

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ OURA AUTO-SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BACKEND = 'https://fittrack-backend-one.vercel.app/api/oura';

async function syncOura() {
  const syncBtn = document.getElementById('syncBtn');
  const syncStatus = document.getElementById('syncStatus');
  if (syncBtn) { syncBtn.textContent = '‚ü≥ Sincronizando...'; syncBtn.disabled = true; }
  try {
    const res = await fetch(BACKEND);
    if (!res.ok) throw new Error('Error ' + res.status);
    const data = await res.json();
    if (!state[TODAY].sleep) state[TODAY].sleep = {};
    if (data.readiness?.score) state[TODAY].sleep.readiness = data.readiness.score;
    if (data.sleep?.total_hours) state[TODAY].sleep.hours = data.sleep.total_hours;
    if (data.sleep?.efficiency) state[TODAY].sleep.efficiency = data.sleep.efficiency;
    if (data.sleep?.deep_hours) state[TODAY].sleep.deep = data.sleep.deep_hours;
    if (data.sleep?.hrv_avg) state[TODAY].sleep.hrv = data.sleep.hrv_avg;
    if (data.sleep?.resting_hr) state[TODAY].sleep.restingHr = data.sleep.resting_hr;
    if (!state[TODAY].kcal) state[TODAY].kcal = {};
    if (data.activity?.total_calories) state[TODAY].kcal.burned = data.activity.total_calories;
    if (data.activity?.active_calories) state[TODAY].kcal.active = data.activity.active_calories;
    if (data.activity?.steps) state[TODAY].steps = data.activity.steps;
    state[TODAY].lastSync = new Date().toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
    saveState(state);
    renderSleep();
    renderKcal();
    renderHome();
    const st = document.getElementById('syncStatus');
    const ls = document.getElementById('lastSync');
    if (st) { st.textContent = '‚óè Conectado'; st.style.color = 'var(--green)'; }
    if (ls) ls.textContent = 'Ultima sync: ' + state[TODAY].lastSync;
    showToast('Oura sincronizado ‚úì');
  } catch(err) {
    const st = document.getElementById('syncStatus');
    if (st) { st.textContent = '‚óè Sin conexion'; st.style.color = 'var(--red)'; }
  } finally {
    if (syncBtn) { syncBtn.textContent = '‚Üª Sync Oura'; syncBtn.disabled = false; }
  }
}

function init() {
  updateHeader();
  renderHome();
  renderMeals();
  renderTraining();
  renderSupps();
  renderMetrics();
  renderSleep();
  renderKcal();
  populateExSelect();
  syncOura();
}

function updateHeader() {
  const d = new Date();
  const days = ['Dom','Lun','Mar','Mie','Jue','Vie','Sab'];
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  document.getElementById('headerDate').textContent = `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
  const td = state[TODAY].trainDay;
  document.getElementById('dayBadge').textContent = td === 0 ? 'DESCANSO' : `DIA ${td}`;
}

// ‚îÄ‚îÄ‚îÄ PAGE NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ MACROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TARGETS = { prot:190, carb:240, fat:70, kcal:2400 };
const MEALS_ORDER = ['Desayuno','Almuerzo','Merienda','Cena','Extra'];

function calcTotals() {
  const foods = state[TODAY].foods || [];
  const t = { prot:0, carb:0, fat:0, kcal:0 };
  foods.forEach(f => {
    t.prot += +f.prot||0; t.carb += +f.carb||0; t.fat += +f.fat||0;
    t.kcal += (f.prot*4)+(f.carb*4)+(f.fat*9);
  });
  return t;
}

// ‚îÄ‚îÄ‚îÄ HOME PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calculateDayScore() {
  const t = calcTotals();
  const s = state[TODAY].supps || {};
  const sleep = state[TODAY].sleep || {};
  const foods = state[TODAY].foods || [];
  const trainDay = state[TODAY].trainDay;
  const kcal = state[TODAY].kcal || {};
  
  let scores = {
    macros: 0,
    training: 0,
    sleep: 0,
    supps: 0,
    kcal: 0,
    steps: 0
  };
  
  // MACROS SCORE (0-100): prote√≠na, carbos y grasas
  const pctP = Math.min(100, (t.prot / TARGETS.prot) * 100);
  const pctC = Math.min(100, (t.carb / TARGETS.carb) * 100);
  const pctF = Math.min(100, (t.fat / TARGETS.fat) * 100);
  scores.macros = Math.round((pctP + pctC + pctF) / 3);
  
  // TRAINING SCORE (0-100): ¬øEntren√≥ y complet√≥ ejercicios?
  if (trainDay === 0) {
    scores.training = 100; // Descanso es bueno
  } else {
    const daySets = state[TODAY]['trainSets_'+trainDay] || {};
    let totalSets = 0, doneSets = 0;
    Object.values(daySets).forEach(exSets => {
      exSets.forEach(s => {
        totalSets++;
        if (s.done) doneSets++;
      });
    });
    scores.training = totalSets > 0 ? Math.round((doneSets / totalSets) * 100) : 0;
  }
  
  // SLEEP SCORE (0-100): readiness de Oura
  if (sleep.readiness) {
    scores.sleep = sleep.readiness; // Ya es 0-100
  } else {
    scores.sleep = 0;
  }
  
  // SUPPS SCORE (0-100): cantidad tomados
  const suppsDone = Object.values(s).filter(v => v).length;
  scores.supps = Math.round((suppsDone / SUPPS.length) * 100);
  
  // KCAL BALANCE SCORE (0-100): qu√© tan cerca del objetivo
  const balance = t.kcal - (kcal.burned || 0);
  const target = -300; // D√©ficit de 300 es ideal
  const diff = Math.abs(balance - target);
  scores.kcal = Math.max(0, 100 - (diff / 300) * 50);
  
  // STEPS SCORE (0-100): pasos (10k es ideal)
  const steps = state[TODAY].steps || 0;
  scores.steps = Math.min(100, Math.round((steps / 10000) * 100));
  
  // PROMEDIO GENERAL
  const weights = { macros:0.25, training:0.25, sleep:0.15, supps:0.15, kcal:0.15, steps:0.05 };
  const overall = Math.round(
    scores.macros * weights.macros +
    scores.training * weights.training +
    scores.sleep * weights.sleep +
    scores.supps * weights.supps +
    scores.kcal * weights.kcal +
    scores.steps * weights.steps
  );
  
  return { overall, scores };
}

function renderHome() {
  document.getElementById('homeDate').textContent = document.getElementById('headerDate').textContent;
  
  const dayData = calculateDayScore();
  const overall = dayData.overall;
  const scores = dayData.scores;
  
  // Actualizar c√≠rculo principal
  document.getElementById('dayScore').textContent = overall;
  
  // Color y mensaje seg√∫n score
  let color, label, msg;
  if (overall >= 85) {
    color = 'var(--green)';
    label = '¬°Excelente d√≠a!';
    msg = 'Vas muy bien. Segu√≠ as√≠ üí™';
  } else if (overall >= 70) {
    color = 'var(--accent)';
    label = 'Buen d√≠a';
    msg = 'Muy bien, faltan algunos detalles';
  } else if (overall >= 50) {
    color = 'var(--yellow)';
    label = 'D√≠a regular';
    msg = 'Pod√©s mejorar algunos aspectos';
  } else {
    color = 'var(--red)';
    label = 'D√≠a dif√≠cil';
    msg = 'Ma√±ana es un nuevo d√≠a para mejorar';
  }
  
  const dash = document.getElementById('dayScoreDash');
  if (dash) {
    dash.style.stroke = color;
    const offset = 471 - (471 * overall / 100);
    dash.style.strokeDashoffset = offset;
  }
  
  document.getElementById('dayScore').style.color = color;
  const labelEl = document.getElementById('dayScoreLabel');
  if (labelEl) {
    labelEl.textContent = label;
    labelEl.style.color = color;
  }
  document.getElementById('dayScoreMsg').textContent = msg;
  
  // Actualizar tarjetas de m√©tricas
  const metrics = [
    { id: 'dayMacroScore', val: scores.macros, icon: 'üçΩ', lbl: 'Macros' },
    { id: 'dayTrainScore', val: scores.training, icon: 'üí™', lbl: 'Entreno' },
    { id: 'daySleepScore', val: scores.sleep, icon: 'üåô', lbl: 'Sue√±o' },
    { id: 'daySuppScore', val: scores.supps, icon: 'üíä', lbl: 'Suplementos' },
    { id: 'dayKcalScore', val: scores.kcal, icon: 'üî•', lbl: 'Balance' },
    { id: 'dayStepsScore', val: scores.steps, icon: '‚è∞', lbl: 'Pasos' }
  ];
  
  metrics.forEach(m => {
    const el = document.getElementById(m.id);
    if (el) {
      el.textContent = Math.round(m.val) + '%';
      let metricColor = m.val >= 80 ? 'var(--green)' : m.val >= 60 ? 'var(--yellow)' : 'var(--red)';
      el.style.color = metricColor;
    }
    const statusEl = document.getElementById(m.id.replace('Score', 'Status'));
    if (statusEl) {
      if (m.val >= 80) {
        statusEl.textContent = '‚úì Bien';
        statusEl.style.color = 'var(--green)';
      } else if (m.val >= 60) {
        statusEl.textContent = '‚ö† Regular';
        statusEl.style.color = 'var(--yellow)';
      } else {
        statusEl.textContent = '‚úï Bajo';
        statusEl.style.color = 'var(--red)';
      }
    }
  });
  
  // Sugerencias din√°micas
  const tips = [];
  const t = calcTotals();
  
  if (scores.macros < 70) {
    tips.push({ icon: 'ü•ó', msg: 'Necesitas cumplir mejor tus macros. Falt√° prote√≠na o carbos.' });
  }
  if (scores.training < 50 && state[TODAY].trainDay !== 0) {
    tips.push({ icon: 'üí™', msg: 'Complet√° tu entrenamiento de hoy para maximizar el progreso.' });
  }
  if (scores.sleep < 60 && state[TODAY].sleep && state[TODAY].sleep.readiness) {
    tips.push({ icon: 'üò¥', msg: 'Tu disposici√≥n est√° baja. Considera descansar m√°s o entrenar light.' });
  }
  if (scores.supps < 80) {
    tips.push({ icon: 'üíä', msg: 'Olvidaste algunos suplementos. Record√° tomarlos seg√∫n el horario.' });
  }
  if (scores.kcal < 60) {
    tips.push({ icon: '‚öñÔ∏è', msg: 'Tu balance cal√≥rico est√° lejos del objetivo. Revisa tu ingesta.' });
  }
  if (scores.steps < 50) {
    tips.push({ icon: 'üö∂', msg: 'Pocos pasos hoy. Intent√° caminar m√°s durante el d√≠a.' });
  }
  if (tips.length === 0) {
    tips.push({ icon: '‚≠ê', msg: '¬°Vas muy bien! Segu√≠ con esta disciplina.' });
  }
  
  const tipsContainer = document.getElementById('homeTipsContainer');
  if (tipsContainer) {
    tipsContainer.innerHTML = tips.slice(0, 3).map(t =>
      '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;gap:8px;align-items:center">' +
      '<div style="font-size:16px">' + t.icon + '</div>' +
      '<div style="flex:1;font-size:11px;color:var(--text2)">' + t.msg + '</div>' +
      '</div>'
    ).join('');
  }
}

function renderMeals() {
  const foods = state[TODAY].foods || [];
  const t = calcTotals();

  // Update summary
  document.getElementById('totalProt').textContent = Math.round(t.prot) + 'g';
  document.getElementById('totalCarb').textContent = Math.round(t.carb) + 'g';
  document.getElementById('totalFat').textContent = Math.round(t.fat) + 'g';

  const pPct = Math.min(100, Math.round(t.prot/TARGETS.prot*100));
  const cPct = Math.min(100, Math.round(t.carb/TARGETS.carb*100));
  const fPct = Math.min(100, Math.round(t.fat/TARGETS.fat*100));
  const kPct = Math.min(100, Math.round(t.kcal/TARGETS.kcal*100));

  document.getElementById('protBar').style.width = pPct + '%';
  document.getElementById('carbBar').style.width = cPct + '%';
  document.getElementById('fatBar').style.width = fPct + '%';
  document.getElementById('kcalBar').style.width = kPct + '%';
  document.getElementById('protPct').textContent = pPct + '%';
  document.getElementById('carbPct').textContent = cPct + '%';
  document.getElementById('fatPct').textContent = fPct + '%';
  document.getElementById('kcalPct').textContent = Math.round(t.kcal) + ' / ' + TARGETS.kcal;

  // Update kcal page consumed
  document.getElementById('kcalConsumed').textContent = Math.round(t.kcal);
  updateKcalBalance();

  // Meals
  const container = document.getElementById('mealsContainer');
  container.innerHTML = '';
  MEALS_ORDER.forEach(meal => {
    const mFoods = foods.filter(f => f.meal === meal);
    if (mFoods.length === 0) return;
    const mKcal = mFoods.reduce((s,f) => s + f.prot*4+f.carb*4+f.fat*9, 0);
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="meal-header">
        <div class="meal-name">${meal}</div>
        <div class="meal-kcal">${Math.round(mKcal)} kcal</div>
      </div>
      <div class="meal-items">
        ${mFoods.map((f,i) => `
          <div class="meal-item">
            <div class="meal-item-name">${f.name}</div>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="meal-item-macros">${f.prot}p ¬∑ ${f.carb}c ¬∑ ${f.fat}g</div>
              <button onclick="removeFood('${f.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px">‚úï</button>
            </div>
          </div>`).join('')}
      </div>`;
    container.appendChild(div);
  });
}

function openAddFood() {
  document.getElementById('addFoodModal').classList.add('open');
}
function fillPreset(name, prot, carb, fat) {
  document.getElementById('foodName').value = name;
  document.getElementById('foodProt').value = prot;
  document.getElementById('foodCarb').value = carb;
  document.getElementById('foodFat').value = fat;
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
function addFood() {
  const name = document.getElementById('foodName').value.trim();
  if (!name) return;
  const food = {
    id: Date.now().toString(),
    name, meal: document.getElementById('foodMeal').value,
    prot: +document.getElementById('foodProt').value||0,
    carb: +document.getElementById('foodCarb').value||0,
    fat: +document.getElementById('foodFat').value||0,
  };
  state[TODAY].foods.push(food);
  saveState(state);
  closeModal('addFoodModal');
  document.getElementById('foodName').value=''; document.getElementById('foodProt').value='';
  document.getElementById('foodCarb').value=''; document.getElementById('foodFat').value='';
  renderMeals();
  renderHome();
  showToast('Alimento agregado ‚úì');
}
function removeFood(id) {
  state[TODAY].foods = state[TODAY].foods.filter(f => f.id !== id);
  saveState(state);
  renderMeals();
  renderHome();
}

// ‚îÄ‚îÄ‚îÄ TRAINING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let trainingSets = {};

function setTrainDay(day) {
  state[TODAY].trainDay = day;
  state.lastTrainDay = day;
  trainingSets = {};
  saveState(state);
  updateHeader();
  renderTraining();
  // Update btn styles
  for(let i=0;i<=5;i++) {
    const b = document.getElementById('tbtn'+i);
    if(b) b.className = 'btn btn-sm ' + (i===day?'btn-primary':'btn-ghost');
  }
}

function renderTraining() {
  const day = state[TODAY].trainDay;
  const list = document.getElementById('exerciseList');

  // Style day buttons
  for(let i=0;i<=5;i++) {
    const b = document.getElementById('tbtn'+i);
    if(b) b.className = 'btn btn-sm ' + (i===day?'btn-primary':'btn-ghost');
  }

  if (day === 0) {
    list.innerHTML = `<div class="card" style="text-align:center;padding:40px 20px"><div style="font-size:40px;margin-bottom:12px">üõã</div><div style="color:var(--text2);font-size:14px">Dia de descanso.<br>El cuerpo construye musculo mientras descansa.</div></div>`;
    return;
  }
  const d = TRAINING[day];
  if (!d) return;

  // Load saved sets
  const savedSets = state[TODAY]['trainSets_'+day] || {};

  list.innerHTML = `<div class="section-div">${d.name}</div>`;

  d.exercises.forEach((ex, exIdx) => {
    const card = document.createElement('div');
    card.className = 'exercise-card';
    card.id = 'excard-' + exIdx;

    const exSets = savedSets[exIdx] || Array.from({length:ex.sets}, () => ({kg:'',reps:'',done:false}));

    const setsHtml = exSets.map((s, sIdx) => `
      <div class="set-row">
        <div class="set-num">${sIdx+1}</div>
        <input class="set-input" placeholder="kg" value="${s.kg||''}" oninput="updateSet(${exIdx},${sIdx},'kg',this.value)">
        <input class="set-input" placeholder="${ex.reps}" value="${s.reps||''}" oninput="updateSet(${exIdx},${sIdx},'reps',this.value)">
        <button class="set-check ${s.done?'done':''}" id="sc-${exIdx}-${sIdx}" onclick="toggleSet(${exIdx},${sIdx})">${s.done?'‚úì':''}</button>
      </div>`).join('');

    const doneCount = exSets.filter(s=>s.done).length;

    card.innerHTML = `
      <div class="exercise-header" onclick="toggleExCard(${exIdx})">
        <div>
          <div class="exercise-name">${ex.name}</div>
          <div class="exercise-muscle">${ex.muscle} ¬∑ ${ex.sets}x${ex.reps}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${doneCount > 0 ? `<span class="tag tag-green">${doneCount}/${ex.sets}</span>` : ''}
          <div class="exercise-chevron">‚ñæ</div>
        </div>
      </div>
      <div class="sets-container">
        ${setsHtml}
        <button class="add-set-btn" onclick="addSet(${exIdx})">+ Serie</button>
      </div>`;
    list.appendChild(card);
    if (!savedSets[exIdx]) savedSets[exIdx] = exSets;
  });

  if (!state[TODAY]['trainSets_'+day]) {
    state[TODAY]['trainSets_'+day] = savedSets;
    saveState(state);
  }
}

function toggleExCard(idx) {
  const c = document.getElementById('excard-' + idx);
  c.classList.toggle('open');
}

function updateSet(exIdx, sIdx, field, val) {
  const day = state[TODAY].trainDay;
  if (!state[TODAY]['trainSets_'+day]) return;
  state[TODAY]['trainSets_'+day][exIdx][sIdx][field] = val;
  saveState(state);
}

function toggleSet(exIdx, sIdx) {
  const day = state[TODAY].trainDay;
  if (!state[TODAY]['trainSets_'+day]) return;
  const s = state[TODAY]['trainSets_'+day][exIdx][sIdx];
  s.done = !s.done;
  saveState(state);
  const btn = document.getElementById(`sc-${exIdx}-${sIdx}`);
  btn.className = 'set-check ' + (s.done ? 'done' : '');
  btn.textContent = s.done ? '‚úì' : '';
  if (s.done) showToast('Serie completada ‚úì');
  const allSets = state[TODAY]['trainSets_'+day][exIdx];
  if (allSets.every(s => s.done)) saveExerciseHistory(day, exIdx, allSets);
  renderTraining();
  renderTrainSuggestions();
  renderHome();
  populateExSelect();
}

function addSet(exIdx) {
  const day = state[TODAY].trainDay;
  state[TODAY]['trainSets_'+day][exIdx].push({kg:'',reps:'',done:false});
  saveState(state);
  renderTraining();
  document.getElementById('excard-'+exIdx).classList.add('open');
}

// ‚îÄ‚îÄ‚îÄ SUPPLEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSupps() {
  const taken = state[TODAY].supps || {};
  const groups = {morning: document.getElementById('suppsMorning'), noon: document.getElementById('suppsNoon'), night: document.getElementById('suppsNight')};
  Object.values(groups).forEach(g => g.innerHTML = '');

  let doneCount = 0;
  SUPPS.forEach(s => {
    if (taken[s.id]) doneCount++;
    const div = document.createElement('div');
    div.className = 'supp-item ' + (taken[s.id] ? 'taken' : '');
    div.onclick = () => toggleSupp(s.id);
    div.innerHTML = `
      <div class="supp-check">${taken[s.id]?'‚úì':''}</div>
      <div class="supp-info">
        <div class="supp-name">${s.name}</div>
        <div class="supp-dose">${s.dose}</div>
      </div>
      <div class="supp-time">${s.time}</div>`;
    groups[s.group].appendChild(div);
  });

  document.getElementById('suppDoneCount').textContent = doneCount;
  document.getElementById('suppTotal').textContent = SUPPS.length;
  document.getElementById('suppBar').style.width = Math.round(doneCount/SUPPS.length*100) + '%';
}

function toggleSupp(id) {
  if (!state[TODAY].supps) state[TODAY].supps = {};
  state[TODAY].supps[id] = !state[TODAY].supps[id];
  saveState(state);
  renderSupps();
  renderHome();
  if (state[TODAY].supps[id]) showToast('Suplemento marcado ‚úì');
}

// ‚îÄ‚îÄ‚îÄ METRICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveMetrics() {
  const w = document.getElementById('inpWeight').value;
  const bf = document.getElementById('inpBF').value;
  const mu = document.getElementById('inpMuscle').value;
  const wa = document.getElementById('inpWaist').value;
  if (!w && !bf) return;
  const entry = { date: TODAY, weight: +w||null, bf: +bf||null, muscle: +mu||null, waist: +wa||null };
  state.metricsHistory.unshift(entry);
  if (state.metricsHistory.length > 30) state.metricsHistory = state.metricsHistory.slice(0,30);
  saveState(state);
  renderMetrics();
  showToast('Medicion guardada ‚úì');
  renderBodyChart();
  document.getElementById('inpWeight').value=''; document.getElementById('inpBF').value='';
  document.getElementById('inpMuscle').value=''; document.getElementById('inpWaist').value='';
}

function renderMetrics() {
  const hist = state.metricsHistory || [];
  const latest = hist[0];
  const prev = hist[1];

  if (latest) {
    document.getElementById('metricWeight').textContent = latest.weight || '‚Äî';
    document.getElementById('metricBF').textContent = latest.bf || '‚Äî';
    document.getElementById('metricMuscle').textContent = latest.muscle || '‚Äî';
    document.getElementById('metricWaist').textContent = latest.waist || '‚Äî';

    if (prev && latest.weight && prev.weight) {
      const diff = (latest.weight - prev.weight).toFixed(1);
      const el = document.getElementById('weightChange');
      el.textContent = (diff > 0 ? '‚ñ≤ +' : '‚ñº ') + diff + ' kg';
      el.className = 'metric-change ' + (diff > 0 ? 'up' : 'down');
    }
    if (prev && latest.bf && prev.bf) {
      const diff = (latest.bf - prev.bf).toFixed(1);
      const el = document.getElementById('bfChange');
      el.textContent = (diff > 0 ? '‚ñ≤ +' : '‚ñº ') + diff + '%';
      el.className = 'metric-change ' + (diff > 0 ? 'up' : 'down');
    }
  }

  renderBodyChart();
}


// ‚îÄ‚îÄ‚îÄ EXERCISE HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveExerciseHistory(day, exIdx, sets) {
  const ex = TRAINING[day]?.exercises[exIdx];
  if (!ex) return;
  const key = ex.name;
  if (!state.exerciseHistory[key]) state.exerciseHistory[key] = [];
  if (state.exerciseHistory[key].find(h => h.date === TODAY)) return;
  const kgVals = sets.map(s => parseFloat(s.kg)).filter(v => !isNaN(v) && v > 0);
  const repsVals = sets.map(s => parseFloat(s.reps)).filter(v => !isNaN(v) && v > 0);
  if (kgVals.length === 0) return;
  const maxKg = Math.max(...kgVals);
  const avgReps = repsVals.length ? Math.round(repsVals.reduce((a,b)=>a+b,0)/repsVals.length) : null;
  const oneRM = avgReps ? Math.round(maxKg * (1 + avgReps / 30)) : maxKg;
  state.exerciseHistory[key].unshift({ date:TODAY, maxKg, avgReps, oneRM, sets:sets.length });
  if (state.exerciseHistory[key].length > 40) state.exerciseHistory[key] = state.exerciseHistory[key].slice(0,40);
  saveState(state);
}

function findExByName(name) {
  for (const d of Object.values(TRAINING)) {
    const ex = d.exercises.find(e => e.name === name);
    if (ex) return ex;
  }
  return null;
}

// ‚îÄ‚îÄ‚îÄ SUGGESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTrainSuggestions() {
  const container = document.getElementById('trainSuggestions');
  if (!container) return;
  const hist = state.exerciseHistory || {};
  const suggestions = [];

  Object.entries(hist).forEach(([name, history]) => {
    if (history.length < 2) return;
    const recent = history.slice(0, 6);
    const latest = recent[0];

    // Stalled: same kg 3+ sessions
    if (recent.length >= 3) {
      const last3 = recent.slice(0,3).map(h => h.maxKg);
      if (last3.every(v => v === last3[0])) {
        suggestions.push({ type:'warn', icon:'‚ö†Ô∏è',
          title:'Estancamiento ‚Äî ' + name,
          sub: last3.length + ' sesiones con ' + last3[0] + 'kg. Sub√≠ a ' + (last3[0]+2.5).toFixed(1) + 'kg o sum√° 1 rep.'
        });
      }
    }

    // Ready to progress: at top of rep range
    const ex = findExByName(name);
    if (ex && latest.avgReps) {
      const parts = ex.reps.split('-');
      const topReps = parts.length > 1 ? +parts[1] : null;
      if (topReps && latest.avgReps >= topReps) {
        suggestions.push({ type:'info', icon:'‚¨ÜÔ∏è',
          title:'Subir peso ‚Äî ' + name,
          sub: 'Llegaste a ' + latest.avgReps + ' reps con ' + latest.maxKg + 'kg. Prob√° ' + (latest.maxKg+2.5).toFixed(1) + 'kg.'
        });
      }
    }

    // New PR
    const allOneRM = history.map(h => h.oneRM || h.maxKg);
    if (history.length >= 2 && latest.oneRM === Math.max(...allOneRM)) {
      suggestions.push({ type:'success', icon:'üèÜ',
        title:'PR ‚Äî ' + name,
        sub: '1RM estimado: ' + latest.oneRM + 'kg (' + latest.maxKg + 'kg √ó ' + (latest.avgReps||'?') + ' reps)'
      });
    }
  });

  if (suggestions.length === 0) {
    container.innerHTML = '<div style="color:var(--text3);font-size:12px;text-align:center;padding:14px 0">Aparecen despu√©s de completar algunas sesiones ‚úì</div>';
    return;
  }
  container.innerHTML = suggestions.slice(0,5).map(s =>
    '<div class="suggestion-card ' + s.type + '">' +
    '<div class="suggestion-icon">' + s.icon + '</div>' +
    '<div><div class="suggestion-title">' + s.title + '</div>' +
    '<div class="suggestion-sub">' + s.sub + '</div></div></div>'
  ).join('');
}

// ‚îÄ‚îÄ‚îÄ STRENGTH CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateExSelect() {
  const sel = document.getElementById('exSelect');
  if (!sel) return;
  const hist = state.exerciseHistory || {};
  const allEx = [];
  Object.values(TRAINING).forEach(d => d.exercises.forEach(e => allEx.push(e.name)));
  sel.innerHTML = '<option value="">‚Äî Seleccionar ejercicio ‚Äî</option>' +
    [...new Set(allEx)].map(name => {
      const hasData = hist[name] && hist[name].length > 0;
      return '<option value="' + name + '">' + (hasData ? 'üìä ' : '') + name + '</option>';
    }).join('');
}

function drawLineChart(svgId, data, color) {
  const svg = document.getElementById(svgId);
  if (!svg) return;
  if (data.length < 2) {
    svg.innerHTML = '<text x="180" y="85" text-anchor="middle" fill="var(--text3)" font-size="12" font-family="DM Sans,sans-serif">Sin suficientes datos a√∫n</text>';
    return;
  }
  const W=360, H=160, pL=38, pR=10, pT=14, pB=26;
  const vals = data.map(d=>d.val);
  const minV = Math.min(...vals), maxV = Math.max(...vals);
  const range = maxV - minV || 1;
  const px = i => pL + (i/(data.length-1))*(W-pL-pR);
  const py = v => pT + (1-(v-minV)/range)*(H-pT-pB);
  let html = '';
  [0, 0.5, 1].forEach(t => {
    const y = pT + t*(H-pT-pB);
    const v = (maxV - t*range).toFixed(1);
    html += '<line class="chart-grid" x1="' + pL + '" x2="' + (W-pR) + '" y1="' + y + '" y2="' + y + '"/>';
    html += '<text class="chart-label-y" x="' + (pL-4) + '" y="' + (y+3) + '">' + v + '</text>';
  });
  const aPath = 'M' + px(0) + ',' + py(data[0].val) + ' ' +
    data.map((d,i)=>'L'+px(i)+','+py(d.val)).join(' ') +
    ' L'+px(data.length-1)+','+(H-pB)+' L'+px(0)+','+(H-pB)+' Z';
  html += '<path d="' + aPath + '" fill="' + color + '" class="chart-area"/>';
  html += '<path d="M' + px(0) + ',' + py(data[0].val) + ' ' +
    data.map((d,i)=>'L'+px(i)+','+py(d.val)).join(' ') +
    '" class="chart-line" stroke="' + color + '"/>';
  data.forEach((d,i) => {
    const x=px(i), y=py(d.val);
    html += '<circle cx="' + x + '" cy="' + y + '" r="4" fill="' + color + '" stroke="var(--bg)" stroke-width="2"/>';
    if (data.length<=7 || i%Math.ceil(data.length/6)===0)
      html += '<text class="chart-label-x" x="' + x + '" y="' + (H-pB+14) + '">' + d.label + '</text>';
  });
  svg.innerHTML = html;
}

function renderStrengthChart() {
  const name = document.getElementById('exSelect')?.value;
  const wrap = document.getElementById('strengthChartWrap');
  const statsEl = document.getElementById('strengthChartStats');
  const histList = document.getElementById('exHistoryList');
  if (!name) {
    if(wrap) wrap.style.display='none';
    if(statsEl) statsEl.innerHTML='';
    if(histList) histList.innerHTML='';
    return;
  }
  const history = (state.exerciseHistory||{})[name] || [];
  if (history.length === 0) {
    wrap.style.display='none';
    statsEl.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:14px 0">Sin datos ‚Äî complet√° las series para ver el progreso.</div>';
    histList.innerHTML=''; return;
  }
  const chartData = history.slice().reverse().map(h=>({ val:h.oneRM||h.maxKg, label:h.date.slice(5) }));
  wrap.style.display = chartData.length >= 2 ? 'block' : 'none';
  if (chartData.length >= 2) drawLineChart('strengthChartSvg', chartData, 'var(--accent)');
  const latest = history[0], prev = history[1];
  const allOneRM = history.map(h=>h.oneRM||h.maxKg);
  const maxOneRM = Math.max(...allOneRM);
  const diff = prev ? ((latest.oneRM||latest.maxKg)-(prev.oneRM||prev.maxKg)).toFixed(1) : null;
  statsEl.innerHTML = '<div class="stat-trio">' +
    '<div class="stat-pill"><div class="stat-pill-val" style="color:var(--accent)">' + latest.maxKg + 'kg</div><div class="stat-pill-lbl">√öltimo peso</div></div>' +
    '<div class="stat-pill"><div class="stat-pill-val" style="color:var(--yellow)">' + maxOneRM + 'kg</div><div class="stat-pill-lbl">1RM estimado</div></div>' +
    '<div class="stat-pill"><div class="stat-pill-val" style="color:' + (diff>0?'var(--green)':diff<0?'var(--red)':'var(--text)') + '">' + (diff!=null?((+diff>0?'+':'')+diff+'kg'):'‚Äî') + '</div><div class="stat-pill-lbl">vs anterior</div></div>' +
    '</div>';
  histList.innerHTML = '<div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin:10px 0 6px">Historial</div>' +
    history.slice(0,8).map(h => {
      const isPR = (h.oneRM||h.maxKg) === maxOneRM;
      return '<div class="ex-history-item"><div class="ex-history-date">' + h.date + '</div>' +
        '<div style="display:flex;align-items:center"><div class="ex-history-val">' + h.maxKg + 'kg √ó ' + (h.avgReps||'?') + ' reps</div>' +
        (isPR?'<span class="ex-history-pr">PR</span>':'') + '</div></div>';
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ BODY COMPOSITION CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentBodyMetric = 'weight';

function selectBodyChart(metric, btn) {
  currentBodyMetric = metric;
  document.querySelectorAll('#bodyChartSelector .prog-sel-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderBodyChart();
}

function renderBodyChart() {
  const configs = {
    weight: { key:'weight', color:'var(--accent)',   unit:'kg', best:'max' },
    bf:     { key:'bf',     color:'var(--yellow)',   unit:'%',  best:'min' },
    muscle: { key:'muscle', color:'var(--green)',    unit:'%',  best:'max' },
    waist:  { key:'waist',  color:'var(--accent2)',  unit:'cm', best:'min' },
  };
  const cfg = configs[currentBodyMetric];
  const hist = (state.metricsHistory||[]).slice().reverse();
  const data = hist.filter(h=>h[cfg.key]!=null).map(h=>({ val:h[cfg.key], label:h.date.slice(5) }));
  drawLineChart('bodyChartSvg', data, cfg.color);
  const statsEl = document.getElementById('bodyChartStats');
  if (data.length >= 2) {
    const first=data[0].val, last=data[data.length-1].val;
    const diff=(last-first).toFixed(1);
    const best = cfg.best==='min' ? Math.min(...data.map(d=>d.val)) : Math.max(...data.map(d=>d.val));
    const diffGood = (cfg.best==='max'&&+diff>0)||(cfg.best==='min'&&+diff<0);
    statsEl.innerHTML =
      '<div class="stat-pill"><div class="stat-pill-val" style="color:' + cfg.color + '">' + last + cfg.unit + '</div><div class="stat-pill-lbl">Actual</div></div>' +
      '<div class="stat-pill"><div class="stat-pill-val" style="color:' + (diffGood?'var(--green)':'var(--red)') + '">' + (+diff>0?'+':'') + diff + cfg.unit + '</div><div class="stat-pill-lbl">Cambio total</div></div>' +
      '<div class="stat-pill"><div class="stat-pill-val" style="color:var(--yellow)">' + best + cfg.unit + '</div><div class="stat-pill-lbl">' + (cfg.best==='min'?'M√≠nimo':'M√°ximo') + '</div></div>';
  } else {
    statsEl.innerHTML = '<div style="color:var(--text3);font-size:12px;width:100%;text-align:center;padding:10px 0">Registr√° al menos 2 mediciones para ver el gr√°fico.</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ AI NUTRITION CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NUTRITION_BACKEND = 'https://fittrack-backend-one.vercel.app/api/nutrition';
let lastAIResult = null;

function openAIChat() {
  document.getElementById('aiChatModal').classList.add('open');
  setTimeout(() => document.getElementById('aiInput').focus(), 300);
}
function closeAIChat() {
  document.getElementById('aiChatModal').classList.remove('open');
}
function sendAIChip(el) {
  document.getElementById('aiInput').value = el.textContent.trim();
  sendAIMessage();
}
function appendBubble(text, type) {
  const area = document.getElementById('aiChatArea');
  const div = document.createElement('div');
  div.className = 'ai-bubble ' + type;
  div.innerHTML = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
  return div;
}
function buildResultCard(data) {
  const meals = ['Desayuno','Almuerzo','Merienda','Cena','Extra'];
  const itemsHtml = data.items && data.items.length > 1
    ? '<div class="ai-items-list">' + data.items.map(it => '‚Ä¢ ' + it.food + ' (' + it.amount + '): ' + it.prot + 'p ¬∑ ' + it.carb + 'c ¬∑ ' + it.fat + 'g').join('<br>') + '</div>' : '';
  return '<div class="ai-result-card">' +
    '<div style="font-size:13px;font-weight:700;margin-bottom:8px">üìä ' + data.name + '</div>' +
    '<div class="ai-result-macros">' +
      '<div class="ai-macro-pill"><div class="val prot-color">' + data.prot + 'g</div><div class="lbl">Prot</div></div>' +
      '<div class="ai-macro-pill"><div class="val carb-color">' + data.carb + 'g</div><div class="lbl">Carbs</div></div>' +
      '<div class="ai-macro-pill"><div class="val fat-color">' + data.fat + 'g</div><div class="lbl">Grasas</div></div>' +
      '<div class="ai-macro-pill"><div class="val kcal-color">' + data.kcal + '</div><div class="lbl">Kcal</div></div>' +
    '</div>' +
    itemsHtml +
    (data.notes ? '<div class="ai-notes">üí° ' + data.notes + '</div>' : '') +
    '<div style="font-size:11px;color:var(--text3);margin-bottom:8px;font-weight:600">Agregar a:</div>' +
    '<div class="ai-add-btns">' + meals.map(m => '<button class="ai-meal-btn" onclick="addAIToMeal(\'' + m + '\')">' + m + '</button>').join('') + '</div>' +
    '</div>';
}
function addAIToMeal(meal) {
  if (!lastAIResult) { showToast('‚ö† Sin resultado de IA'); return; }
  state[TODAY].foods.push({ id:Date.now().toString(), name:lastAIResult.name, meal, prot:+lastAIResult.prot||0, carb:+lastAIResult.carb||0, fat:+lastAIResult.fat||0 });
  saveState(state);
  renderMeals();
  renderHome();
  showToast('‚úì Agregado a ' + meal);
  document.querySelectorAll('.ai-meal-btn').forEach(b => { if(b.textContent===meal){b.textContent='‚úì Listo';b.classList.add('primary');} });
}

async function parseWithClaude(query) {
  const prompt = `Sos un nutricionista experto. El usuario describe lo que comi√≥. Calcul√° los macros totales.
Respond√© SOLO con un JSON v√°lido, sin texto extra, sin markdown, sin backticks. Formato exacto:
{"name":"nombre corto del plato","prot":25,"carb":40,"fat":8,"kcal":336,"notes":"nota opcional breve","items":[{"food":"ingrediente","amount":"200g","prot":25,"carb":40,"fat":8}]}
- prot, carb, fat, kcal deben ser n√∫meros (no strings)
- Si es un solo alimento, items puede tener solo ese elemento
- kcal = prot*4 + carb*4 + fat*9
Usuario dice: "${query}"`;

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 500,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  const raw = await res.json();
  const text = raw.content?.[0]?.text || '';
  // Limpiar posibles backticks
  const clean = text.replace(/```json|```/g, '').trim();
  return JSON.parse(clean);
}

async function sendAIMessage() {
  const inp = document.getElementById('aiInput');
  const query = inp.value.trim();
  if (!query) return;
  const btn = document.getElementById('aiSendBtn');
  btn.disabled = true; inp.value = '';
  appendBubble(query, 'user');
  const loading = appendBubble('Analizando...', 'bot loading');
  
  let data = null;
  let errorMsg = '';

  // Intentar primero con el backend de Vercel
  try {
    const res = await fetch(NUTRITION_BACKEND, { 
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body:JSON.stringify({query}),
      signal: AbortSignal.timeout(8000)
    });
    if (res.ok) {
      const json = await res.json();
      if (json && !json.error && json.prot !== undefined) {
        data = json;
      } else {
        errorMsg = json.error || 'Backend sin datos v√°lidos';
      }
    } else {
      errorMsg = 'Backend HTTP ' + res.status;
    }
  } catch(e) {
    errorMsg = 'Backend: ' + e.message;
  }

  // Si el backend fall√≥, usar Claude directamente
  if (!data) {
    try {
      data = await parseWithClaude(query);
    } catch(e2) {
      loading.className = 'ai-bubble bot';
      loading.innerHTML = '‚ùå No se pudo analizar.<br><small style="color:var(--text3)">Backend: ' + errorMsg + '<br>Claude: ' + e2.message + '</small>';
      btn.disabled = false;
      document.getElementById('aiInput').focus();
      return;
    }
  }

  loading.remove();
  lastAIResult = data;
  appendBubble(buildResultCard(data), 'bot');
  btn.disabled = false;
  document.getElementById('aiInput').focus();
}

// ‚îÄ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSleep() {
  const s = state[TODAY].sleep || {};
  const r = s.readiness;

  // Readiness circle
  if (r) {
    const circle = document.getElementById('readinessDash');
    const offset = 251.2 - (251.2 * r / 100);
    circle.style.strokeDashoffset = offset;
    const color = r >= 70 ? 'var(--green)' : r >= 60 ? 'var(--yellow)' : 'var(--red)';
    circle.style.stroke = color;
    document.getElementById('readinessNum').textContent = r;
    document.getElementById('readinessNum').style.color = color;
    document.getElementById('readinessLabel').textContent = r >= 70 ? 'BUENA ‚Äî Entrenar normal' : r >= 60 ? 'MODERADA ‚Äî Sin forzar' : 'BAJA ‚Äî Bajar volumen';
    document.getElementById('readinessLabel').style.color = color;
  }

  if (s.hours) document.getElementById('sleepHours').textContent = s.hours + 'h';
  if (s.efficiency) document.getElementById('sleepEff').textContent = s.efficiency + '%';
  if (s.deep) document.getElementById('sleepDeep').textContent = s.deep + 'h';
  if (s.hrv) document.getElementById('sleepHRV').textContent = s.hrv + ' ms';

  // HRV chart (last 7 days)
  const days7 = [];
  for (let i=6;i>=0;i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const key = d.toISOString().split('T')[0];
    const dayData = state[key];
    days7.push({ label: ['D','L','M','X','J','V','S'][d.getDay()], hrv: dayData?.sleep?.hrv || 0 });
  }
  const maxHrv = Math.max(...days7.map(d=>d.hrv), 1);
  const chart = document.getElementById('hrvChart');
  const labels = document.getElementById('hrvLabels');
  chart.innerHTML = days7.map(d => `
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px">
      ${d.hrv ? `<div style="font-size:9px;color:var(--text3);font-family:'Space Mono',monospace">${d.hrv}</div>` : ''}
      <div style="width:100%;background:${d.hrv>0?'var(--accent)':'var(--bg4)'};border-radius:4px 4px 0 0;height:${d.hrv?Math.max(4,Math.round(d.hrv/maxHrv*50)):4}px"></div>
    </div>`).join('');
  labels.innerHTML = days7.map(d => `<div style="flex:1;text-align:center;font-size:10px;color:var(--text3)">${d.label}</div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ KCAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateKcalBalance() {
  renderKcal();
}

function renderKcal() {
  const consumed = Math.round(calcTotals().kcal);
  const burned = state[TODAY]?.kcal?.burned || 0;
  const balance = consumed - burned;

  document.getElementById('kcalConsumed').textContent = consumed;
  document.getElementById('kcalBurned').textContent = burned;
  document.getElementById('kcalBalance').textContent = (balance > 0 ? '+' : '') + balance;
  document.getElementById('kcalBalance').style.color = balance > 0 ? 'var(--red)' : 'var(--green)';

  // Balance bar
  if (burned > 0) {
    const absDiff = Math.abs(balance);
    const pct = Math.min(50, Math.round(absDiff / burned * 50 * 2));
    document.getElementById('deficitBar').style.width = balance < 0 ? pct + '%' : '0%';
    document.getElementById('surplusBar').style.width = balance > 0 ? pct + '%' : '0%';
  }

  // History
  const hist = state.kcalHistory || [];
  const histEl = document.getElementById('kcalHistory');
  if (hist.length === 0) { histEl.innerHTML = '<div class="empty"><div class="empty-icon">üî•</div>Sin historial aun</div>'; return; }
  histEl.innerHTML = hist.slice(0,7).map(e => {
    const bal = e.consumed - e.burned;
    return `<div class="history-row">
      <div class="history-date">${e.date.slice(5)}</div>
      <div class="history-vals">
        <span class="history-val">${e.consumed} consumidas</span>
        <span class="history-val" style="color:${bal<0?'var(--green)':'var(--red)'}">${bal>0?'+':''}${bal}</span>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
